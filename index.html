<!DOCTYPE html> 
<html>
<head>
	<title>jQuery Mobile Pages</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">	
		
	<link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css" />
	 <link rel="stylesheet" href="css/jquery-ui.css">
	<!-- link to jQuery and jQuery Mobile JavaScript libraries: -->
	<script src="js/jquery-1.10.1.min.js"></script>
	<script src="js/jquery.mobile-1.3.1.min.js"></script>	 	 
	 <script src="js/jquery-ui.js"> </script>
	<script type="text/javascript" src="cordova.js"></script> 	
	<script async defer src="//maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&key=AIzaSyCNOiO5P22wUCCOe7MIquPFPps4b6N3LAI&ver=3.exp"></script>
 <script>
	var serverURL="http://localhost/LSS/LSSserver/"; // The server address of the PHP files
	var baseURL="http://localhost/LSS/";
 </script>
</head>

<body  style="display: instructions;">
	<div id="dialog" title="Location Log">
		<p id="alertclass1">Location Log</p>
	</div>
	
<!-- the div below is a page - the home page -->
<div data-role="page" id="instructions">

	<!-- the div below is the home page's header -->
	<div data-role="header">
		<h1>Instructions</h1>
		<div data-role="navbar">
	        <ul>
	            <li><a href="#instructions" class="ui-btn-active ui-state-persist" data-icon="home">Instructions</a></li>
	            <li><a href="#log" data-icon="star">Log</a></li>
	            <li><a href="#exit" data-icon="info">Exit</a></li>
	        </ul>
	    </div>
	</div>

	<!-- the div below is the home page's main content -->
	<div data-role="content">
		<p>How to use this App</p>
		<ol>
		<li> Launch the application on your phone </li>
		<li> Go to to Log menu </li>
		<li> Put your registered finger on the scanner </li>
		<li> Confirm if you wish to log the location</li>
		<li> Exit the application</li>
		</ol>
		
	</div>

	<!-- the div below is the home page's footer -->
	<div data-role="footer">
		<h4>Location Log  &copy;Lavington Security Limited</h4>
	</div>
</div>

<!-- the div below is a page - the about page -->
<div data-role="page" id="log">
	<div data-role="header">
		<h1>Log</h1>
		<div data-role="navbar">
	        <ul>
	            <li><a href="#instructions" data-icon="home">Instructions</a></li>
	            <li><a href="#log" class="ui-btn-active ui-state-persist" data-icon="star">Log</a></li>
	            <li><a href="#exit" data-icon="info">Exit</a></li>
	        </ul>
	    </div>
	</div>
	<div data-role="content">
		<p>Press the button to log your current location</p>
		<script>
		$(document).ready(function(){		
		$("#btnLogLocation").click(function(){
		//	getCurrentLocation();	
			getLocation();			
			//logAlert("Are you sure you want to log?");
		});	
			
				});
		</script>
	<div id="locaDetails">
		<p>Country: <span id="country"></span></p>
		<p>State: <span id="state"></span></p>
		<p>City: <span id="city"></span></p>
		<p>Address: <span id="address"></span></p>
		<p>Latitude: <span id="latitude"></span></p>
		<p>Longitude: <span id="longitude"></span></p>
	</div>
	<div id="mapholder">Map</div>
	
	<div> <a data-role="button" data-icon="flat-settings" data-theme="d" id="btnLogLocation" >Log</a></div>
	</div>
	<div data-role="footer" data-theme="e">
		<h4>Location Log  &copy;Lavington Security Limited</h4>
	</div>
</div>

<!-- the div below is a page - the contact page -->
<div data-role="page" id="exit">
		<script>
		$(document).ready(function(){		
		$("#btnExitapp").click(function(){		
		//alert("Clicked button");	
			exitAlert("Are you sure you want exit App?");
		});
	});
		</script>
	<div data-role="header">
		<h1>Exit</h1>
		<div data-role="navbar">
	        <ul>
	            <li><a href="#instructions" data-icon="home">Instructions</a></li>
	            <li><a href="#log" data-icon="star">Log</a></li>
	            <li><a href="#exit" class="ui-btn-active ui-state-persist" data-icon="info">Exit</a></li>
	        </ul>
	    </div>
	</div>
	<div data-role="content">
		<p>To exit this app, click the button</p>
		<div> <a data-role="button" data-icon="flat-settings" data-theme="d" id="btnExitapp" >Exit</a></div>
	</div>
	<div data-role="footer">
		<h4>Location Log  &copy;Lavington Security Limited</h4>
	</div>
</div>
<script>
	function getLocation() {
    if(navigator.geolocation) {
	navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }
	function geoSuccess(position) {
    var lat = position.coords.latitude;
    var lng = position.coords.longitude;
    alert("lat:" + lat + " and lng:" + lng);
	codeLatLng(lat, lng);
}
function geoError() {
    alert("Geocoder failed.");
}
	function codeLatLng(lat, lng) {
	var geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(lat, lng);
    geocoder.geocode({'latLng': latlng}, function(results, status) {
	alert("results=  "+ results)
      if(status == google.maps.GeocoderStatus.OK) {
          console.log(results)
          if(results[1]) {
              //formatted address
              var address = results[0].formatted_address;
              alert("address = " + address);
          } else {
              alert("No results found");
          }
      } else {
          alert("Geocoder failed due to: " + status);
      }
    });
	}
	
	function watchPosition() {
	var options = {
      maximumAge: 3600000,
      timeout: 3000,
      enableHighAccuracy: true,
   }
   var watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
   function onSuccess(position) {
      alert('Latitude: '          + position.coords.latitude          + '\n' +
         'Longitude: '         + position.coords.longitude         + '\n' +
         'Altitude: '          + position.coords.altitude          + '\n' +
         'Accuracy: '          + position.coords.accuracy          + '\n' +
         'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
         'Heading: '           + position.coords.heading           + '\n' +
         'Speed: '             + position.coords.speed             + '\n' +
         'Timestamp: '         + position.timestamp                + '\n');
	};

	function onError(error) {
      alert('code: '    + error.code    + '\n' +'message: ' + error.message + '\n');
	}
	}
	function getCurrentLocation(){
	alert("starting current loc1");
	var options = {
      enableHighAccuracy: true,
      maximumAge: 3600000
   }
   var watchID = navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
	var latitude="";
	var longitude="";
	var altitude="";
	
	function onSuccess(position) {
		alert("starting current loc2");
		 latitude= position.coords.latitude;          
         longitude= position.coords.longitude;
         altitude= position.coords.altitude;
		 alert("starting current loc1 latitude"+latitude);
		 alert("starting current loc1 longitude"+longitude);
	
		};
   function onError(error) {
      alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
   }
   var params = {
	ignoreSSLErrors: true /* BOOLEAN */,
    useNTLM: false /* BOOLEAN */,
    timeout: 60 /* NUMBER */,
	url: "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + 
	latitude +"," + longitude + "&key=AIzaSyCNOiO5P22wUCCOe7MIquPFPps4b6N3LAI"  /* STRING */
	};
	// result: JSON
	alert("starting current Results");
	var result = Resources["ContentLoaderFunctions"].GetJSON(params);
	var rawJSON = result;
	alert("starting current Results="+result);
	var LocationText = result.results[0].formatted_address;
	alert ("Location is =  "+LocationText); 

	}
	function findLocation(){
	 /* Chrome need SSL! */
            var is_chrome = /chrom(e|ium)/.test( navigator.userAgent.toLowerCase() );
            var is_ssl    = 'https:' == document.location.protocol;
           /* if( is_chrome && ! is_ssl ){
			alert("Fail at chrome test");
                return false;
            } 
			/*
            /* HTML5 Geolocation */
			alert("Past chrome test");
            navigator.geolocation.getCurrentPosition(
                function( position ){ // success cb     
                    /* Current Coordinate */
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
					alert("lat and  lng= "+lat + " AND "+lng);
                    var google_map_pos = new google.maps.LatLng( lat, lng );     
                    /* Use Geocoder to get address */
                    var google_maps_geocoder = new google.maps.Geocoder();
						alert("AT google_maps_geocoder");
                    google_maps_geocoder.geocode(
                        { 'latLng': google_map_pos 
						},						
                        function( results, status ) {
                            if ( status == google.maps.GeocoderStatus.OK && results[0] ) {
                                console.log( results[0].formatted_address );
								alert( results[0].formatted_address );
                            }
                        }
                    );
                },
                function(){ // fail cb
                }
            );
	}
	function getDeviceDetails(){
	  alert("Cordova version: " + device.cordova + "\n" +
      "Device model: " + device.model + "\n" +
      "Device platform: " + device.platform + "\n" +
      "Device UUID: " + device.uuid + "\n" +
      "Device version: " + device.version);
	}
	function readFingerprint(){	
		//document.addEventListener('deviceready', function () {
			alert("Device ready");
			FingerprintAuth.isAvailable(function (result) {
			console.log("FingerprintAuth available: " + JSON.stringify(result));
			alert("FingerprintAuth available: " + JSON.stringify(result));
    
    // If has fingerprint device and has fingerprints registered
		if (result.isAvailable == true && result.hasEnrolledFingerprints == true) {
        // Check the docs to know more about the encryptConfig object :)
        var encryptConfig = {
            clientId: "myAppName",
            username: "currentUser",
            password: "currentUserPassword",
            maxAttempts: 5,
            locale: "en_US",
            dialogTitle: "Scan Finger",
            dialogMessage: "Kindly put your registered finger on the device",
            dialogHint: "Ensure that you see the Successfully logged message "
        }; // See config object for required parameters
        // Set config and success callback
        FingerprintAuth.encrypt(encryptConfig, function(_fingerResult){
            console.log("successCallback(): " + JSON.stringify(_fingerResult));
            if (_fingerResult.withFingerprint) {
                console.log("Successfully Successfully logged location.");
		 alert("Successfully encrypted credentials.");
                console.log("Encrypted credentials: " + result.token);
			alert("Encrypted credentials: " + result.token);
			
			getCurrentLocation();//Display the current possition				
            
			} else if (_fingerResult.withBackup) {
                console.log("Authenticated with backup password");
		    alert("Authenticated with backup password");
            }
        // Error callback
        }, function(err){
                if (err === "Cancelled") {
                console.log("FingerprintAuth Dialog Cancelled!");
			 alert("FingerprintAuth Dialog Cancelled!");
			
            } else {
                console.log("FingerprintAuth Error: " + err);
		     alert("FingerprintAuth Error: " + err);
            }
        });
    }
		/**
		* @return {
		*      isAvailable:boolean,
		*      isHardwareDetected:boolean,
		*      hasEnrolledFingerprints:boolean
		*   }
		*/
	}, function (message) {
    console.log("isAvailableError(): " + message);
	   alert("isAvailableError(): " + message);
		});
	//});	
	
	}
	
	function logAlert(msg) {
		dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
		document.getElementById("alertclass1").innerHTML=msg;
			$( "#dialog" ).dialog({
			autoOpen: true,
			modal: true,
			width: 300,
			height: 200,
			buttons:{
			Yes: function() {
			$(this).dialog("close");			
			//1. Call the fingerprint function and then
			readFingerprint();
			//Call log location function
    },
		No: function() {
        $(this).dialog("close");
        //myCancelFunction();
		window.location.replace(baseURL +"index.html#log");
		//alert("Choose cancel");
    }
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  }
  	function exitAlert(msg) {
		dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
		document.getElementById("alertclass1").innerHTML=msg;
	  $( "#dialog" ).dialog({
		autoOpen: true,
		modal: true,
		width: 300,
		height: 200,
		buttons:{
		Yes: function() {
        $(this).dialog("close");
		//alert("Choose ok"); 
		//cordova.plugins.exit();
		navigator.app.exitApp();		
        //myOkFunction();
    },
		No: function() {
        $(this).dialog("close");
        //myCancelFunction();
		window.location.replace(baseURL +"index.html#exit");
		//alert("Choose cancel");
    }
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  }   
	function displayAlert(response) {
	dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
	document.getElementById("alertclass1").innerHTML=response;
	  $( "#dialog" ).dialog({
		autoOpen: true,
		modal: true,
		width: 300,
		height: 200,
		buttons: {
		Ok: function() {
		$( this ).dialog( "close" );
		}
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  } 
</script>
</body>
</html>
